<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.blog.mapper.BlogMapper">

	<!-- 统计博客的总数 -->
	<select id="count" resultType="long">
		select count(*) from blog b where b.is_deleted IS NOT TRUE AND b.is_published IS NOT FALSE
	</select>

	<!-- 列出所有博客和对应的类型名称 -->
	<select id="listBlogAndType" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,t.name typeName from blog b inner join type t on b.type_id = t.id order by update_time desc
	</select>

	<!-- 通过id查找博客 -->
	<select id="findById" parameterType="long" resultType="blog">
		select * from blog where id = #{id}
	</select>

	<!-- 搜索博客 -->
	<select id="listBySearch" parameterType="com.blog.dto.BlogQueryDTO" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,t.name typeName from blog b inner join type t on b.type_id = t.id
		<where>
			<if test="title != '' and title != null">
				and b.title like concat('%',#{title},'%')
			</if>
			<if test="typeId != '' and typeId != null">
				and b.type_id = #{typeId}
			</if>
			<if test="isRecommend == true">
				and b.is_recommend = true
			</if>
		</where>
		order by update_time desc
	</select>
	
	<!-- 通过id查找博客和对应的类型，标签 -->
	<select id="findBlogAndTypeById" parameterType="long" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,type.id typeId
		from blog b
		inner join type on b.type_id=type.id
		where b.id=#{id}
	</select>
	
	<!-- 列出首页展示的博客相关信息  -->
	<select id="listTopBlog" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,u.avatar userAvatar,u.nickname userNickname,t.name typeName
		from blog b INNER JOIN user u on b.user_id = u.id
		INNER JOIN type t on b.type_id = t.id where b.is_deleted is not true and b.is_published is not false order by update_time desc
	</select>
	
	<!-- 通过分类id获取博客相关信息 -->
	<select id="listTypeBlogByTypeId" parameterType="long" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,u.avatar userAvatar,u.nickname userNickname,t.name typeName
		from blog b INNER JOIN user u on b.user_id = u.id
		INNER JOIN type t on b.type_id = t.id where b.is_deleted is not true and b.is_published is not false and b.type_id = #{id} 
		order by update_time desc
	</select>
	
	<!-- 通过标签id获取博客相关信息 -->
	<select id="listTagBlogByTagId" parameterType="long" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,u.avatar userAvatar,u.nickname userNickname,t.name typeName
		from blog b INNER JOIN user u on b.user_id = u.id
		INNER JOIN type t on b.type_id = t.id 
		INNER JOIN blog_tag bt on b.id = bt.blog_id
		INNER JOIN tag on bt.tag_id = tag.id
		where b.is_deleted is not true and b.is_published is not false and tag.id = #{id}
		order by update_time desc
	</select>
	
	<!-- 列出首页展示的推荐博客 -->
	<select id="listTopRecommendBlog" parameterType="int" resultType="blog">
		select id,title from blog where is_commented = true order by update_time desc limit #{topRecommendNum}
	</select>
	
	<!-- 获取博客详情页的信息 -->
	<select id="findBlogDetailById" parameterType="long" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,u.avatar userAvatar,u.nickname userNickname,t.name typeName
		from blog b INNER JOIN user u on b.user_id = u.id
		INNER JOIN type t on b.type_id = t.id where b.id = #{id}
	</select>
	
	<!-- 列出所有的年份 -->
	<select id="listGroupYear" resultType="string">
		SELECT DATE_FORMAT(b.update_time,'%Y') ud from blog b GROUP BY ud ORDER BY ud desc
	</select>
	
	<!-- 根据年份获取博客 -->
	<select id="archiveBlog" resultType="blog">
		select b.id,b.title,b.update_time,b.flag from blog b 
		where b.is_deleted IS NOT TRUE AND b.is_published IS NOT FALSE 
		order by update_time desc
	</select>
	
	<!-- 通过关键字搜索博客 -->
	<select id="listByQuery" parameterType="string" resultType="com.blog.dto.BlogTypeTagDTO">
		select b.*,u.avatar userAvatar,u.nickname userNickname,t.name typeName,t.id typeId
		from blog b INNER JOIN user u on b.user_id = u.id
		INNER JOIN type t on b.type_id = t.id
		where b.is_deleted IS NOT TRUE AND b.is_published IS NOT FALSE 
		  and b.title like concat('%',#{query},'%') or b.content like concat('%',#{query},'%') or b.description like concat('%',#{query},'%')
	</select>

	<!-- 插入博客数据 -->
	<insert id="save" parameterType="com.blog.dto.BlogTypeTagDTO"
		useGeneratedKeys="true" keyProperty="id">
		insert into blog
		(title,content,description,first_picture,flag,original_link,view_count,comment_count,like_count,down_count,is_appreciated,is_shared,is_commented,is_deleted,is_recommend,is_top,is_privated,is_published,create_time,update_time,type_id,user_id)
		values
		(#{title},#{content},#{description},#{firstPicture},#{flag},#{originalLink},#{viewCount},#{commentCount},#{likeCount},#{downCount},#{isAppreciated},#{isShared},#{isCommented},#{isDeleted},#{isRecommend},#{isTop},#{isPrivated},#{isPublished},#{createTime},#{updateTime},#{typeId},#{userId})
	</insert>

	<!-- 通过id更新博客 -->
	<update id="update" parameterType="blog">
		update blog set
		title=#{title},content=#{content},description=#{description},first_picture=#{firstPicture},flag=#{flag},is_appreciated=#{isAppreciated},is_shared=#{isShared},is_commented=#{isCommented},is_recommend=#{isRecommend},is_published=#{isPublished},update_time=#{updateTime},type_id=#{typeId}
		where id =#{id}
	</update>
	
	<!-- 根据id增加博客访问数量 -->
	<update id="incViewCntById" parameterType="long">
		update blog set view_count = view_count + #{viewCntWrite} where id = #{id}
	</update>
	
	<!-- 通过id给博客设置删除标志 -->
	<update id="deleteById" parameterType="long">
		update blog set is_deleted = true where id = #{id}
	</update>
	
	<!-- 通过类型id给博客设置删除标志 -->
	<update id="deleteByTypeId" parameterType="long">
		update blog set is_deleted = true where type_id = #{typeId}
	</update>
</mapper>